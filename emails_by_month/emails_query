WITH email_month AS (
SELECT DISTINCT
    DATE_TRUNC(DATE_ADD(s.date, INTERVAL es.sent_date DAY), MONTH) AS sent_month,
    es.id_account AS id_account,
    COUNT(*) OVER(PARTITION BY DATE_TRUNC(DATE_ADD(s.date, INTERVAL es.sent_date DAY), MONTH), id_account) AS msg_acc_month,
    COUNT(*) OVER(PARTITION BY DATE_TRUNC(DATE_ADD(s.date, INTERVAL es.sent_date DAY), MONTH)) AS msg_month,
    DATE_ADD(s.date, INTERVAL es.sent_date DAY) AS sent_date
  FROM `DA.email_sent` es
  JOIN `DA.account_session` acs ON es.id_account = acs.account_id
  JOIN `DA.session` s ON acs.ga_session_id = s.ga_session_id)
SELECT
  DISTINCT sent_month,
  id_account,
  msg_acc_month / msg_month * 100 AS sent_msg_percent_from_this_month,
  MIN(sent_date) OVER(PARTITION BY sent_month, id_account) AS first_sent_date,
  MAX(sent_date) OVER(PARTITION BY sent_month, id_account) AS last_sent_date
FROM email_month
